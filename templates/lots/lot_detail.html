{% extends "base.html" %}
{% block title %}{{ lot.title }}{% endblock %}

{% load price %}

{% block content %}

<div class="row g-4">

  <div class="col-md-6">
    <div class="card antique p-2">

      <!-- ГАЛЕРЕЯ -->
      <div id="lightgallery" class="d-flex flex-column gap-2">

        <!-- Большое главное фото -->
        {% if lot.main_image %}
        <div style="text-align: center; line-height: 0;">
            <a href="{{ lot.main_image.url }}"
               class="gallery-main"
               data-lg-size="{{ lot.main_image.width }}-{{ lot.main_image.height }}"
               style="display: inline-block; line-height: 0; overflow: hidden; border-radius: 8px;">
              <img src="{{ lot.preview_image.url|default:lot.main_image.url }}"
                   alt="{{ lot.title }}"
                   style="width: auto; max-width: 100%; height: auto; max-height: 500px; display: block; margin: 0 auto;">
            </a>
        </div>
        {% endif %}

        {% if lot.images.all %}
        <div class="d-flex flex-wrap gap-2 mt-3">
          {% for img in lot.images.all %}
          <a href="{{ img.image.url }}"
             class="gallery-thumb"
             data-lg-size="{{ img.image.width }}-{{ img.image.height }}">
            <img src="{{ img.preview_image.url|default:img.image.url }}"
                 alt="{{ lot.title }} - фото {{ forloop.counter }}"
                 style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px; display: block;">
          </a>
          {% endfor %}
        </div>
        {% endif %}

      </div>

    </div>
  </div>

  <div class="col-md-6">
    <div class="card antique p-4">
      <h2 class="antique-header">{{ lot.title }}</h2>
      <h5>{{ lot.price|price }} ₽</h5>

      <article>{{ lot.description|linebreaks }}</article>

      {% if lot.tags_list %}
      <div class="mt-3 d-flex flex-wrap gap-2">
        {% for t in lot.tags_list %}
        <a href="{% url 'lots:lot_list' %}?tag={{ t|urlencode }}"
           class="tag">
          {{ t|title }}
        </a>
        {% endfor %}
      </div>
      {% endif %}

      <a href="https://t.me/magiyastarinybot?start=lot_{{ lot.id }}"
         class="btn btn-outline-dark mt-3"
         target="_blank">
        Связаться по этому предмету
      </a>

      <button onclick="history.length > 1 ? history.back() : window.location.href='{% url 'lots:lot_list' %}';"
              class="btn btn-outline-dark mt-3">
        Назад
      </button>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<style>
  .lg-outer .lg-img-wrap {
      padding: 0 10px !important;
  }

  .lg-object.lg-image {
    max-width: 100% !important;
    height: auto !important;
  }

  .gallery-main, .gallery-thumb {
    cursor: pointer !important;
    display: block;
    line-height: 0;
    -webkit-tap-highlight-color: transparent;
  }

  .gallery-main img, .gallery-thumb img {
    transition: transform 0.2s ease-in-out, opacity 0.3s ease;
  }

  .gallery-main:hover img {
    transform: scale(1.01);
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const galleryElement = document.getElementById('lightgallery');

  const isMobile = window.innerWidth < 768;

  const gallery = lightGallery(galleryElement, {
    selector: '.gallery-main, .gallery-thumb',
    plugins: [lgZoom, lgThumbnail],

    speed: 350,
    mode: 'lg-slide',

    zoom: true,
    enableZoomAfter: 100,
    allowMediaOverlap: false,

    zoomFromOrigin: !isMobile,

    getBoundBox: true,
    download: false,

    mobileSettings: {
      controls: true,
      showCloseIcon: true,
      download: false
    }
  });

  const images = galleryElement.querySelectorAll('img');
  images.forEach(img => {
    if (img.complete) {
        img.style.opacity = '1';
    } else {
        img.style.opacity = '0';
        img.onload = function() { this.style.opacity = '1'; };
    }
  });
});
</script>
{% endblock %}